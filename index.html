<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Pixel City - Norwegian Neighborhood</title>
    <style>
        :root {
            --ui-bg: #c6c6c6;
            --ui-border-light: #ffffff;
            --ui-border-dark: #555;
            --block-size: 80px;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background: #1a1a1a;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            user-select: none;
        }

        #game-viewport {
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
        }

        #city-container {
            display: grid;
            gap: 2px;
            background: #3d8c40; /* Grønnere plen-farge */
            padding: 15px;
            image-rendering: pixelated;
            transition: transform 0.6s ease;
            max-width: 70vw; 
            border: 4px solid #2d5a24;
        }

        .slot {
            width: var(--block-size); height: var(--block-size);
            position: relative; box-sizing: border-box;
        }

        /* ASSETS */
        .asset { position: absolute; width: 100%; height: 100%; animation: pop 0.3s steps(3); z-index: 2; }
        
        .house { 
            background: #b22222; /* Klassisk rød hytte/hus */
            border: 10px solid #800000; 
            width: 70%; height: 70%; top: 15%; left: 15%;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3);
        } 
        
        .garden { background: #7cfc00; border: 4px dotted #55a600; width: 80%; height: 80%; top: 10%; left: 10%; }
        
        .tree { 
            background: #2d5a24; border-radius: 50%; 
            width: 30px; height: 30px; margin: 25px; 
            box-shadow: 3px 3px 0 #1e3d18; 
        }

        /* VEI-SYSTEM (Basert på bildet ditt) */
        .road { background: #444; z-index: 1 !important; }
        .road::after {
            content: ''; position: absolute;
            background: white; opacity: 0.6;
        }
        .road-h::after { top: 48%; left: 10%; right: 10%; height: 4px; }
        .road-v::after { left: 48%; top: 10%; bottom: 10%; width: 4px; }
        
        /* Svinger som faktisk ser ut som svinger */
        .road-corner { border-radius: 0; }
        .c-tl { border-top-left-radius: 30px; }
        .c-tr { border-top-right-radius: 30px; }
        .c-bl { border-bottom-left-radius: 30px; }
        .c-br { border-bottom-right-radius: 30px; }

        /* PENGE-ANIMS (Forbedret stabilitet) */
        .money { position: absolute; z-index: 9999; pointer-events: none; }
        .pixel-coin { width: 22px; height: 22px; background: #ffd700; border: 2px solid #b8860b; border-radius: 2px; }
        
        /* UI */
        .ui-panel { position: absolute; background: var(--ui-bg); border: 4px solid var(--ui-border-light); border-right-color: var(--ui-border-dark); border-bottom-color: var(--ui-border-dark); padding: 12px; z-index: 10000; }
        #money-ui { top: 20px; left: 20px; font-size: 24px; font-weight: bold; color: #2d5a24; }
        #shop-ui { top: 20px; right: 20px; width: 240px; max-height: 85vh; overflow-y: auto; }
        .shop-item { background: #999; border: 2px solid #eee; padding: 10px; margin: 6px 0; cursor: pointer; display: flex; justify-content: space-between; font-size: 12px; }
        .shop-item.disabled { opacity: 0.5; cursor: not-allowed; }

        @keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }
        .fade-out { opacity: 0; transition: opacity 0.5s ease-out; }
    </style>
</head>
<body>

<div id="money-ui" class="ui-panel">COINS: <span id="coin-count">0</span></div>
<div id="shop-ui" class="ui-panel">
    <div style="text-align:center; font-weight:bold; margin-bottom:10px;">BYGGEPLAN</div>
    <div id="shop-content"></div>
</div>
<div id="game-viewport"><div id="city-container"></div></div>

<script>
    let state = {
        coins: 0,
        gridSize: 2,
        history: {}
    };

    // LOGISK NABOLAGS-PLAN (Inspirert av bildet)
    function getPlannedType(i, size) {
        let x = i % size;
        let y = Math.floor(i / size);

        // Vei-loop (Langs kanten av nabolaget)
        if (y === 0 || y === size - 1 || x === 0 || x === size - 1) return 'road';

        // Avstand mellom hus (Annet hver felt er hage/tre)
        if ((x + y) % 2 === 0) return 'house';
        return (x * y) % 3 === 0 ? 'garden' : 'tree';
    }

    const buildings = [
        { id: 'vei', name: "Vei", cost: 10, class: 'road' },
        { id: 'hus', name: "Enebolig", cost: 150, class: 'house' },
        { id: 'hage', name: "Hage", cost: 40, class: 'garden' },
        { id: 'tre', name: "Furu", cost: 20, class: 'tree' }
    ];

    const container = document.getElementById('city-container');

    function drawCity() {
        container.style.gridTemplateColumns = `repeat(${state.gridSize}, var(--block-size))`;
        container.innerHTML = '';

        for (let i = 0; i < state.gridSize * state.gridSize; i++) {
            let slot = document.createElement('div');
            slot.className = 'slot';
            slot.id = `slot-${i}`;
            if (state.history[i]) addAsset(slot, state.history[i], i);
            container.appendChild(slot);
        }
        adjustZoom();
        updateUI();
    }

    function addAsset(slot, type, index) {
        let asset = document.createElement('div');
        asset.className = `asset ${type}`;
        
        if (type === 'road') {
            let x = index % state.gridSize;
            let y = Math.floor(index / state.gridSize);
            let s = state.gridSize - 1;

            // Avansert sving-deteksjon for hjørner
            if (x === 0 && y === 0) asset.classList.add('c-tl');
            else if (x === s && y === 0) asset.classList.add('c-tr');
            else if (x === 0 && y === s) asset.classList.add('c-bl');
            else if (x === s && y === s) asset.classList.add('c-br');
            
            // Striper
            if (y === 0 || y === s) asset.classList.add('road-h');
            else asset.classList.add('road-v');
        }
        slot.appendChild(asset);
    }

    function adjustZoom() {
        const scale = Math.min(1, (window.innerWidth * 0.65) / (state.gridSize * 85), (window.innerHeight * 0.8) / (state.gridSize * 85));
        container.style.transform = `scale(${scale})`;
    }

    // STABIL PENGE-FYSIKK
    document.body.addEventListener('mousedown', (e) => {
        if(e.target.closest('.ui-panel')) return;
        
        // Alltid 6 mynter per klikk for følelsen av rikdom
        for(let i=0; i<6; i++) {
            setTimeout(() => spawnMoney(e.clientX, e.clientY), i * 30);
        }
        state.coins += 12;
        updateUI();
    });

    function spawnMoney(x, y) {
        const el = document.createElement('div');
        el.className = 'money pixel-coin';
        document.body.appendChild(el);
        
        let px = x + (Math.random() * 30 - 15);
        let py = y;
        let vx = (Math.random() - 0.5) * 8;
        let vy = -8 - Math.random() * 5;
        
        function step() {
            vy += 0.5; px += vx; py += vy;
            if (py >= window.innerHeight - 30
