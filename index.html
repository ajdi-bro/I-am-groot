<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Retro City Architect - Smooth Build</title>
    <style>
        :root {
            --ui-bg: #c6c6c6;
            --ui-border-light: #ffffff;
            --ui-border-dark: #555;
            --block-size: 80px;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background: #1a1a1a;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            user-select: none;
        }

        #game-viewport {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #city-container {
            display: grid;
            gap: 2px;
            background: #222;
            padding: 4px;
            image-rendering: pixelated;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .slot {
            width: var(--block-size);
            height: var(--block-size);
            background: #4da33d;
            position: relative;
        }

        /* PIXEL BUILDINGS - OVENFRA */
        .asset { position: absolute; width: 100%; height: 100%; animation: pop 0.3s steps(3); }
        .house { background: #8b4513; border: 12px solid #5d2e0d; box-sizing: border-box; } 
        .road { background: #333; }
        .road::after { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 4px; border-top: 4px dashed #eee; transform: translateY(-50%); }
        .garden { background: #7cfc00; border: 8px solid #55a600; box-sizing: border-box; }
        .tree { background: #2d5a24; border-radius: 50%; width: 50%; height: 50%; margin: 25%; box-shadow: 4px 4px 0 #1e3d18; }
        .police { background: #00008b; border: 10px solid #0000cd; box-sizing: border-box; }
        .park { background: #228b22; border: 4px solid #006400; }

        /* FYSIKK-PENGER */
        .money {
            position: absolute;
            z-index: 9999;
            pointer-events: none;
            image-rendering: pixelated;
        }
        .pixel-coin {
            width: 20px; height: 20px;
            background: #ffd700; border: 2px solid #b8860b;
            box-shadow: 2px 2px 0 #8b6508;
        }
        .pixel-bill {
            width: 40px; height: 20px;
            background: #71aa37; border: 2px solid #2d5a24;
            box-shadow: 3px 3px 0 #1e3d18;
            color: white; font-size: 10px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }

        /* UI */
        .ui-panel {
            position: absolute; background: var(--ui-bg); border: 4px solid var(--ui-border-light);
            border-right-color: var(--ui-border-dark); border-bottom-color: var(--ui-border-dark);
            padding: 12px; z-index: 10000; box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
        }
        #money-ui { top: 20px; left: 20px; font-size: 24px; font-weight: bold; }
        #shop-ui { top: 20px; right: 20px; width: 220px; max-height: 80vh; overflow-y: auto; }

        .shop-item {
            background: #999; border: 2px solid #eee; border-right-color: #444; border-bottom-color: #444;
            padding: 8px; margin: 6px 0; cursor: pointer; display: flex; justify-content: space-between; font-size: 12px;
        }
        .shop-item.disabled { opacity: 0.5; cursor: not-allowed; color: #444; }

        @keyframes pop { from { transform: scale(0); } to { transform: scale(1); } }
        .fade-out { opacity: 0; transition: opacity 0.4s; }
    </style>
</head>
<body>

<div id="money-ui" class="ui-panel">COINS: <span id="coin-count">0</span></div>

<div id="shop-ui" class="ui-panel">
    <div style="text-align: center; border-bottom: 2px solid #555; margin-bottom: 10px; font-weight: bold;">BUTIKK</div>
    <div id="shop-content"></div>
</div>

<div id="game-viewport">
    <div id="city-container"></div>
</div>

<script>
    let state = {
        coins: 0,
        totalSpent: 0,
        clickCount: 0,
        gridSize: 2,
        billValue: 10,
        builtCount: 0
    };

    const buildingTypes = [
        { id: 'hage', name: "Hage", cost: 10, bonus: 1, class: 'garden' },
        { id: 'tre', name: "Tre", cost: 15, bonus: 1, class: 'tree' },
        { id: 'vei', name: "Vei", cost: 20, bonus: 2, class: 'road' },
        { id: 'hus', name: "Hus", cost: 200, bonus: 10, class: 'house' },
        { id: 'park', name: "Park", cost: 800, bonus: 25, class: 'park', unlock: 400 },
        { id: 'politi', name: "Politi", cost: 2000, bonus: 60, class: 'police', unlock: 1000 }
    ];

    const container = document.getElementById('city-container');

    // Initialiserer rutenettet første gang uten å tømme det senere
    function createInitialGrid() {
        container.style.gridTemplateColumns = `repeat(${state.gridSize}, var(--block-size))`;
        for(let i=0; i < state.gridSize * state.gridSize; i++) {
            addSlot();
        }
        adjustZoom();
    }

    function addSlot() {
        let slot = document.createElement('div');
        slot.className = 'slot';
        container.appendChild(slot);
    }

    function adjustZoom() {
        const padding = 80;
        const availableW = window.innerWidth - (padding * 2);
        const availableH = window.innerHeight - (padding * 2);
        const gridPx = state.gridSize * 82;
        
        let scale = Math.min(availableW / gridPx, availableH / gridPx);
        if(scale > 1) scale = 1;
        
        container.style.transform = `scale(${scale})`;
    }

    // Penge-fysikk
    document.body.addEventListener('mousedown', (e) => {
        if(e.target.closest('.ui-panel')) return;
        
        state.clickCount++;
        let isBill = state.clickCount % 5 === 0;
        let amount = isBill ? 1 : 5;
        
        for(let i=0; i < amount; i++) {
            spawnMoney(e.clientX, e.clientY, isBill);
        }

        state.coins += isBill ? state.billValue : amount;
        updateUI();
    });

    function spawnMoney(x, y, isBill) {
        const el = document.createElement('div');
        el.className = `money ${isBill ? 'pixel-bill' : 'pixel-coin'}`;
        if(isBill) el.innerText = state.billValue;
        document.body.appendChild(el);

        let px = x + (Math.random() * 40 - 20);
        let py = y;
        let vx = (Math.random() - 0.5) * 10;
        let vy = -Math.random() * 10 - 5;
        const grav = 0.6;
        const bnc = -0.5;
        const floor = window.innerHeight - 30;

        function animate() {
            vy += grav;
            px += vx;
            py += vy;

            if (py >= floor) {
                py = floor;
                vy *= bnc;
                vx *= 0.8;
            }

            el.style.left = px + 'px';
            el.style.top = py + 'px';
            el.style.transform = `rotate(${px}deg)`;

            if (Math.abs(vy) > 0.5 || py < floor - 5) {
                requestAnimationFrame(animate);
            } else {
                setTimeout(() => {
                    el.classList.add('fade-out');
                    setTimeout(() => el.remove(), 400);
                }, 1000);
            }
        }
        requestAnimationFrame(animate);
    }

    function updateUI() {
        document.getElementById('coin-count').innerText = Math.floor(state.coins);
        const shop = document.getElementById('shop-content');
        shop.innerHTML = '';

        buildingTypes.forEach(b => {
            if(b.unlock && state.totalSpent < b.unlock) return;

            const item = document.createElement('div');
            const canAfford = state.coins >= b.cost;
            item.className = `shop-item ${!canAfford ? 'disabled' : ''}`;
            item.innerHTML = `<span>${b.name}</span> <span>${b.cost}c</span>`;
            
            if(canAfford) {
                item.onclick = (e) => {
                    e.stopPropagation();
                    buyBuilding(b);
                };
            }
            shop.appendChild(item);
        });
    }

    function buyBuilding(b) {
        const slots = document.querySelectorAll('.slot');
        // Finn den neste ledige slokken (den som ikke har en .asset)
        let targetSlot = null;
        for (let slot of slots) {
            if (!slot.querySelector('.asset')) {
                targetSlot = slot;
                break;
            }
        }

        if (targetSlot) {
            state.coins -= b.cost;
            state.totalSpent += b.cost;
            state.builtCount++;
            state.billValue += 2;
            b.cost = Math.floor(b.cost * 1.4);

            // LEGG TIL KUN DEN NYE BLOKKA UTEN Å RELOADE ALT
            let asset = document.createElement('div');
            asset.className = `asset ${b.class}`;
            targetSlot.appendChild(asset);

            // Sjekk om vi har fylt opp kvadratet og må legge til nye TOMME blokker
            if(state.builtCount === state.gridSize * state.gridSize) {
                expandGrid();
            }

            updateUI();
        }
    }

    function expandGrid() {
        const oldSize = state.gridSize;
        state.gridSize += 2;
        const newTotal = state.gridSize * state.gridSize;
        const currentTotal = oldSize * oldSize;
        
        // Oppdater grid-kolonner
        container.style.gridTemplateColumns = `repeat(${state.gridSize}, var(--block-size))`;
        
        // Legg til de nye tomme blokkene
        for (let i = 0; i < (newTotal - currentTotal); i++) {
            addSlot();
        }
        
        // Zoom ut for å få plass til de nye blokkene
        adjustZoom();
    }

    window.onresize = adjustZoom;
    createInitialGrid();
    updateUI();
</script>
</body>
</html>
